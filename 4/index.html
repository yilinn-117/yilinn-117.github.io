<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 4A: Image Warping and Mosaicing</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        header {
            background-color: #333;
            color: white;
            padding: 10px 0;
            text-align: center;
        }
        h1 {
            margin: 0;
            font-size: 36px;
        }
        section {
            margin: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 6px; 
        }


        .image-gallery img {
            width: 100%; 
            height: auto; 
            display: block;
        }

        .image-container {
            display: flex;
            flex-wrap: wrap;
            text-align: center;
            width: 100%;
            gap: 5px;
        }
        .image-container img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .image-container figcaption {
            margin-top: 5px;
            font-style: italic;
        }
        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 10px 0;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<header>
    <h1>Project 4A: Image Warping and Mosaicing</h1>
</header>
    
<section>
    <h2>Shoot the Pictures</h2>
    <p>
        Those are the images I used in this project
    </p>
    <h3>for Rectification:</h3>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./poster.jpg" alt="Original">
            <figcaption>Poster on Library Wall</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./campanile.jpg" alt="D_x">
            <figcaption>Campanile</figcaption>
        </figure>
    </div>
    <h3>for Mosaicing:</h3>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./wurster_center.jpg" alt="Original">
            <figcaption>Wurster Hall</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./wurster_up.jpg" alt="D_x">
            <figcaption></figcaption>
        </figure>
        <figure class="image-container">
            <img src="./fountain_down.jpg" alt="Original">
            <figcaption>Fountain</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./fountain_up.jpg" alt="D_x">
            <figcaption></figcaption>
        </figure>
        <figure class="image-container">
            <img src="./EECS_left.jpg" alt="Original">
            <figcaption>EECS Hall</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./EECS_right.jpg" alt="D_x">
            <figcaption></figcaption>
        </figure>
    </div>
</section>

<section>
    <h2>Recover Homographies</h2>
    <h3>Theoratical Backgroud</h3>
    <p>We know that to do projective warping, we need to get the homography matrix H where Hp = p' and </p>
    <p>
        \[
        H =
        \begin{bmatrix}
        a & b & c \\
        d & e & f \\
        g & h & 1
        \end{bmatrix}
        \]
    </p>
    <p>H denotes the transformation</p>
    <p>
        \[
        p =
        \begin{bmatrix}
        x \\
        y \\
        1
        \end{bmatrix}
        \]
    </p>
    <p>p denotes a point in the base image</p>
    <p>
        \[
        p' =
        \begin{bmatrix}
        wx' \\
        wy' \\
        w
        \end{bmatrix}
        \]        
    </p>
    <p>p' denotes a point in the warped image</p>
    <p>
        \[
        w =
        \begin{bmatrix}
        g & h & 1
        \end{bmatrix}
        \times
        \begin{bmatrix}
        x \\
        y \\
        1
        \end{bmatrix}
        \]        
    </p>
    <p>w is calculated as this</p>
    <p>Substitude w in the above formula and expanding it, we found that coefficients in H could be expressed as</p>
    <p>
        \[
        \begin{bmatrix}
        x & y & 1 & 0 & 0 & 0 & -xx' & -yx' \\
        0 & 0 & 0 & x & y & 1 & -xy' & -yy'
        \end{bmatrix}

        \begin{bmatrix}
        a \\
        b \\
        c \\
        d \\
        e \\
        f \\ 
        g \\
        h \\
        \end{bmatrix}
        =
        \begin{bmatrix}
        x' \\
        y'
        \end{bmatrix}
        \]
    </p>
    <p>substitude each p & p' pairs and stack them in form of </p>
    <p>
        \[
        \begin{bmatrix}
        x_1 & y_1 & 1 & 0 & 0 & 0 & -xx' & -yx' \\
        0 & 0 & 0 & x_1 & y_1 & 1 & -xy' & -yy' \\
        x_2 & y_2 & 1 & 0 & 0 & 0 & -xx' & -yx' \\
        0 & 0 & 0 & x_2 & y_2 & 1 & -xy' & -yy' \\
        e & t & c & e & t & c & . & .
        \end{bmatrix}

        \begin{bmatrix}
        a \\
        b \\
        c \\
        d \\
        e \\
        f \\ 
        g \\
        h \\
        \end{bmatrix}
        =
        \begin{bmatrix}
        x'_1 \\
        y'_1 \\
        x'_2 \\
        y'_2 \\
        . \\
        .
        \end{bmatrix}
        \]
    </p>
    <p>We could solve for coefficients of H using least square where </p>
    <p>
        \[
        x = (A^{t}A)^{-1} A^{t}b
        \]    
    </p>
    <p>where</p>
    <p>
        \[
        x =         
        \begin{bmatrix}
        a \\
        b \\
        c \\
        d \\
        e \\
        f \\ 
        g \\
        h \\
        \end{bmatrix}
        \]    
    </p>
    <p>
        \[
        A =         
        \begin{bmatrix}
        x_1 & y_1 & 1 & 0 & 0 & 0 & -xx' & -yx' \\
        0 & 0 & 0 & x_1 & y_1 & 1 & -xy' & -yy' \\
        x_2 & y_2 & 1 & 0 & 0 & 0 & -xx' & -yx' \\
        0 & 0 & 0 & x_2 & y_2 & 1 & -xy' & -yy' \\
        e & t & c & e & t & c & . & .
        \end{bmatrix}
        \]    
    </p>
    <p>
        \[
        b =         
        \begin{bmatrix}
        x'_1 \\
        y'_1 \\
        x'_2 \\
        y'_2 \\
        . \\
        .
        \end{bmatrix}
        \]    
    </p>

</section>



<section>
    <h2>Warping the Images</h2>
    <p>
        First thing to do in warping is to calculate the transformation matrix H, which needs correspondence points p p' pairs to do:
    </p>
    <p>Below are the correspondence I annotated</p>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./wurster_pts1.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption></figcaption>
        </figure>
        <figure class="image-container">
            <img src="./wurster_pts2.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption></figcaption>
        </figure>
    </div>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./EECSleft_pts.png" alt="Original">
            <figcaption></figcaption>
        </figure>
        <figure class="image-container">
            <img src="./EECSright_pts.png" alt="Original">
            <figcaption></figcaption>
        </figure>
    </div>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./fountaindown_pts.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption></figcaption>
        </figure>
        <figure class="image-container">
            <img src="./fountainup_pts.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption></figcaption>
        </figure>
    </div>
    <p> 
        The second step to do warping is to calculate the coordinate of warped image, where I do by first apply the calculated H to the four corners of the original 
        rectangular image to find the polygon shape where the warp is going to take form. Then, I use inverse warping: I loop over each of the points in the final polygon
        and calculate \p = wH^{-1}p'\ as the point on the original image to do interpolation for color and feed the color back into the final polygon.
    </p>
    <p>
        Below are the warped image of wurster hall, fountain and EECS hall:
    </p>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./wurster_warp.png" alt="Original">
            <figcaption>Warped high perspective of Wurster</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./fountain_warp.png" alt="Original">
            <figcaption>Warped high perspective of fountain</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./EECS_warp.png" alt="Original">
            <figcaption>Warped right perspective of EECS Hall</figcaption>
        </figure>
    </div>
</section>


<section>
    <h2>Rectify Images</h2>
    <p>
        After implementing the warping function, we could rectify an image: simply annotate a known rectangle in an image and warp it toward a 
        set of 4 points which compose a rectangle. The set of 4 points are chosen by hand, but their value should be adjusted to preserve original resolution.
    </p>
    <p>Below are the annotated images and their rectifications, the original image could be found in section 'Shoot the Pictures' above</p>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./poster_pts.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Annotated poster</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./trans_poster.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Rectified poster</figcaption>
        </figure>
    </div>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./campanile_pts.png" alt="Original">
            <figcaption>Annotated campanile</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./trans_campanile.png" alt="Original">
            <figcaption>Rectified campanile</figcaption>
        </figure>
    </div>
</section>

<section>
    <h2>Blending into Mosaic</h2>
    <p>
        After obtaining the warped image, there are two more steps before we could morph warped and original into a mosaic, 
        the two steps are alignment and blending.
    </p>
    <h3>Alignment</h3>
    <p>
        To do alignment between the original and the warped image. I obtain a mean point by average between the
        annotated points in base image and transformed annotated point in the warped image. Then I stack the mean point and calculate
        the width and height of the final mosaic image by finding the maximum offset between mean point and each of the 4 boundries of original and warped.
    </p>

    <p>Below is the example of alignment on Wurster hall images, the green point denotes the mean point, the gray part is occupied by one of the images, black occupied
        by none and white is the intersection.
    </p>

    <div class="image-gallery">
        <figure class="image-container">
            <img src="./align_example.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Meaning point of original</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./align_example1.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Transformed Meaning point of warped</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./alignment_sample.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Mosaic Dimension Demonstration</figcaption>
        </figure>
    </div>
    <h3>Blending</h3>
    <p>
        To do blending, I implemented an alpha mask on the obtained interection in the alignment process.
    </p>

    <p>Below is the vertical alpha mask used on Wurster/fountain images, and the horizontal alpha mask used on the EECS images.</p>

    <div class="image-gallery">
        <figure class="image-container">
            <img src="./vertical_mask.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Vertical Alpha Mask</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./vertical_mask2.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption></figcaption>
        </figure>
    </div>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./horizontal_mask1.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Horizontal Alpha Mask</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./horizontal_mask2.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption></figcaption>
        </figure>
    </div>
    <h3>The Mosaic</h3>
    <p>
        After doing alignment and blending, we could finally create mosaics, below are the mosaics of wurster, fountain and EECS hall, inaccompany of the original images.
    </p>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./wurster_center.jpg" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Original 1</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./wurster_up.jpg" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Original 2</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./trans_wurster.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Mosaic</figcaption>
        </figure>
    </div>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./fountain_down.jpg" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Original 1</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./fountain_up.jpg" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Original 2</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./trans_fountain.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Mosaic</figcaption>
        </figure>
    </div>
    <div class="image-gallery">
        <figure class="image-container">
            <img src="./EECS_left.jpg" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Original 1</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./EECS_right.jpg" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Original 2</figcaption>
        </figure>
        <figure class="image-container">
            <img src="./trans_EECS.png" alt="Offset: r[90,22], g[40,16]">
            <figcaption>Mosaic</figcaption>
        </figure>
    </div>
</section>



<section>
    <h2>Conclusion</h2>
    <p>
        This is a very interesting project, it enables me to transform an image to achieve a semi-change of perspective, which I used to thought was impossible
        since it would be including extra information. It is amazing and satisfying to know that there are tricks we could do to trick our eyes, like projecting original information on a new projection plane.
    </p>

</section>



<footer>
    <p>&copy; Yilin Ni's Project 4A</p>
</footer>

</body>
</html>